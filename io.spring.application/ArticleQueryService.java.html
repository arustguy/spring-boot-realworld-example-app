<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ArticleQueryService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">spring-boot-realworld-example-app</a> &gt; <a href="index.source.html" class="el_package">io.spring.application</a> &gt; <span class="el_source">ArticleQueryService.java</span></div><h1>ArticleQueryService.java</h1><pre class="source lang-java linenums">package io.spring.application;

import static java.util.stream.Collectors.toList;

import io.spring.application.data.ArticleData;
import io.spring.application.data.ArticleDataList;
import io.spring.application.data.ArticleFavoriteCount;
import io.spring.core.user.User;
import io.spring.infrastructure.mybatis.readservice.ArticleFavoritesReadService;
import io.spring.infrastructure.mybatis.readservice.ArticleReadService;
import io.spring.infrastructure.mybatis.readservice.UserRelationshipQueryService;
import java.util.ArrayList;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.Set;
import lombok.AllArgsConstructor;
import org.joda.time.DateTime;
import org.springframework.stereotype.Service;

@Service
<span class="fc" id="L24">@AllArgsConstructor</span>
public class ArticleQueryService {
  private ArticleReadService articleReadService;
  private UserRelationshipQueryService userRelationshipQueryService;
  private ArticleFavoritesReadService articleFavoritesReadService;

  public Optional&lt;ArticleData&gt; findById(String id, User user) {
<span class="fc" id="L31">    ArticleData articleData = articleReadService.findById(id);</span>
<span class="pc bpc" id="L32" title="1 of 2 branches missed.">    if (articleData == null) {</span>
<span class="nc" id="L33">      return Optional.empty();</span>
    } else {
<span class="pc bpc" id="L35" title="1 of 2 branches missed.">      if (user != null) {</span>
<span class="fc" id="L36">        fillExtraInfo(id, user, articleData);</span>
      }
<span class="fc" id="L38">      return Optional.of(articleData);</span>
    }
  }

  public Optional&lt;ArticleData&gt; findBySlug(String slug, User user) {
<span class="nc" id="L43">    ArticleData articleData = articleReadService.findBySlug(slug);</span>
<span class="nc bnc" id="L44" title="All 2 branches missed.">    if (articleData == null) {</span>
<span class="nc" id="L45">      return Optional.empty();</span>
    } else {
<span class="nc bnc" id="L47" title="All 2 branches missed.">      if (user != null) {</span>
<span class="nc" id="L48">        fillExtraInfo(articleData.getId(), user, articleData);</span>
      }
<span class="nc" id="L50">      return Optional.of(articleData);</span>
    }
  }

  public CursorPager&lt;ArticleData&gt; findRecentArticlesWithCursor(
      String tag,
      String author,
      String favoritedBy,
      CursorPageParameter&lt;DateTime&gt; page,
      User currentUser) {
<span class="fc" id="L60">    List&lt;String&gt; articleIds =</span>
<span class="fc" id="L61">        articleReadService.findArticlesWithCursor(tag, author, favoritedBy, page);</span>
<span class="fc bfc" id="L62" title="All 2 branches covered.">    if (articleIds.size() == 0) {</span>
<span class="fc" id="L63">      return new CursorPager&lt;&gt;(new ArrayList&lt;&gt;(), page.getDirection(), false);</span>
    } else {
<span class="pc bpc" id="L65" title="1 of 2 branches missed.">      boolean hasExtra = articleIds.size() &gt; page.getLimit();</span>
<span class="pc bpc" id="L66" title="1 of 2 branches missed.">      if (hasExtra) {</span>
<span class="nc" id="L67">        articleIds.remove(page.getLimit());</span>
      }
<span class="fc bfc" id="L69" title="All 2 branches covered.">      if (!page.isNext()) {</span>
<span class="fc" id="L70">        Collections.reverse(articleIds);</span>
      }

<span class="fc" id="L73">      List&lt;ArticleData&gt; articles = articleReadService.findArticles(articleIds);</span>
<span class="fc" id="L74">      fillExtraInfo(articles, currentUser);</span>

<span class="fc" id="L76">      return new CursorPager&lt;&gt;(articles, page.getDirection(), hasExtra);</span>
    }
  }

  public CursorPager&lt;ArticleData&gt; findUserFeedWithCursor(
      User user, CursorPageParameter&lt;DateTime&gt; page) {
<span class="nc" id="L82">    List&lt;String&gt; followdUsers = userRelationshipQueryService.followedUsers(user.getId());</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">    if (followdUsers.size() == 0) {</span>
<span class="nc" id="L84">      return new CursorPager&lt;&gt;(new ArrayList&lt;&gt;(), page.getDirection(), false);</span>
    } else {
<span class="nc" id="L86">      List&lt;ArticleData&gt; articles =</span>
<span class="nc" id="L87">          articleReadService.findArticlesOfAuthorsWithCursor(followdUsers, page);</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">      boolean hasExtra = articles.size() &gt; page.getLimit();</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">      if (hasExtra) {</span>
<span class="nc" id="L90">        articles.remove(page.getLimit());</span>
      }
<span class="nc bnc" id="L92" title="All 2 branches missed.">      if (!page.isNext()) {</span>
<span class="nc" id="L93">        Collections.reverse(articles);</span>
      }
<span class="nc" id="L95">      fillExtraInfo(articles, user);</span>
<span class="nc" id="L96">      return new CursorPager&lt;&gt;(articles, page.getDirection(), hasExtra);</span>
    }
  }

  public ArticleDataList findRecentArticles(
      String tag, String author, String favoritedBy, Page page, User currentUser) {
<span class="fc" id="L102">    List&lt;String&gt; articleIds = articleReadService.queryArticles(tag, author, favoritedBy, page);</span>
<span class="fc" id="L103">    int articleCount = articleReadService.countArticle(tag, author, favoritedBy);</span>
<span class="fc bfc" id="L104" title="All 2 branches covered.">    if (articleIds.size() == 0) {</span>
<span class="fc" id="L105">      return new ArticleDataList(new ArrayList&lt;&gt;(), articleCount);</span>
    } else {
<span class="fc" id="L107">      List&lt;ArticleData&gt; articles = articleReadService.findArticles(articleIds);</span>
<span class="fc" id="L108">      fillExtraInfo(articles, currentUser);</span>
<span class="fc" id="L109">      return new ArticleDataList(articles, articleCount);</span>
    }
  }

  public ArticleDataList findUserFeed(User user, Page page) {
<span class="fc" id="L114">    List&lt;String&gt; followdUsers = userRelationshipQueryService.followedUsers(user.getId());</span>
<span class="fc bfc" id="L115" title="All 2 branches covered.">    if (followdUsers.size() == 0) {</span>
<span class="fc" id="L116">      return new ArticleDataList(new ArrayList&lt;&gt;(), 0);</span>
    } else {
<span class="fc" id="L118">      List&lt;ArticleData&gt; articles = articleReadService.findArticlesOfAuthors(followdUsers, page);</span>
<span class="fc" id="L119">      fillExtraInfo(articles, user);</span>
<span class="fc" id="L120">      int count = articleReadService.countFeedSize(followdUsers);</span>
<span class="fc" id="L121">      return new ArticleDataList(articles, count);</span>
    }
  }

  private void fillExtraInfo(List&lt;ArticleData&gt; articles, User currentUser) {
<span class="fc" id="L126">    setFavoriteCount(articles);</span>
<span class="pc bpc" id="L127" title="1 of 2 branches missed.">    if (currentUser != null) {</span>
<span class="fc" id="L128">      setIsFavorite(articles, currentUser);</span>
<span class="fc" id="L129">      setIsFollowingAuthor(articles, currentUser);</span>
    }
<span class="fc" id="L131">  }</span>

  private void setIsFollowingAuthor(List&lt;ArticleData&gt; articles, User currentUser) {
<span class="fc" id="L134">    Set&lt;String&gt; followingAuthors =</span>
<span class="fc" id="L135">        userRelationshipQueryService.followingAuthors(</span>
<span class="fc" id="L136">            currentUser.getId(),</span>
<span class="fc" id="L137">            articles.stream()</span>
<span class="fc" id="L138">                .map(articleData1 -&gt; articleData1.getProfileData().getId())</span>
<span class="fc" id="L139">                .collect(toList()));</span>
<span class="fc" id="L140">    articles.forEach(</span>
        articleData -&gt; {
<span class="fc bfc" id="L142" title="All 2 branches covered.">          if (followingAuthors.contains(articleData.getProfileData().getId())) {</span>
<span class="fc" id="L143">            articleData.getProfileData().setFollowing(true);</span>
          }
<span class="fc" id="L145">        });</span>
<span class="fc" id="L146">  }</span>

  private void setFavoriteCount(List&lt;ArticleData&gt; articles) {
<span class="fc" id="L149">    List&lt;ArticleFavoriteCount&gt; favoritesCounts =</span>
<span class="fc" id="L150">        articleFavoritesReadService.articlesFavoriteCount(</span>
<span class="fc" id="L151">            articles.stream().map(ArticleData::getId).collect(toList()));</span>
<span class="fc" id="L152">    Map&lt;String, Integer&gt; countMap = new HashMap&lt;&gt;();</span>
<span class="fc" id="L153">    favoritesCounts.forEach(</span>
        item -&gt; {
<span class="fc" id="L155">          countMap.put(item.getId(), item.getCount());</span>
<span class="fc" id="L156">        });</span>
<span class="fc" id="L157">    articles.forEach(</span>
<span class="fc" id="L158">        articleData -&gt; articleData.setFavoritesCount(countMap.get(articleData.getId())));</span>
<span class="fc" id="L159">  }</span>

  private void setIsFavorite(List&lt;ArticleData&gt; articles, User currentUser) {
<span class="fc" id="L162">    Set&lt;String&gt; favoritedArticles =</span>
<span class="fc" id="L163">        articleFavoritesReadService.userFavorites(</span>
<span class="fc" id="L164">            articles.stream().map(articleData -&gt; articleData.getId()).collect(toList()),</span>
            currentUser);

<span class="fc" id="L167">    articles.forEach(</span>
        articleData -&gt; {
<span class="fc bfc" id="L169" title="All 2 branches covered.">          if (favoritedArticles.contains(articleData.getId())) {</span>
<span class="fc" id="L170">            articleData.setFavorited(true);</span>
          }
<span class="fc" id="L172">        });</span>
<span class="fc" id="L173">  }</span>

  private void fillExtraInfo(String id, User user, ArticleData articleData) {
<span class="fc" id="L176">    articleData.setFavorited(articleFavoritesReadService.isUserFavorite(user.getId(), id));</span>
<span class="fc" id="L177">    articleData.setFavoritesCount(articleFavoritesReadService.articleFavoriteCount(id));</span>
<span class="fc" id="L178">    articleData</span>
<span class="fc" id="L179">        .getProfileData()</span>
<span class="fc" id="L180">        .setFollowing(</span>
<span class="fc" id="L181">            userRelationshipQueryService.isUserFollowing(</span>
<span class="fc" id="L182">                user.getId(), articleData.getProfileData().getId()));</span>
<span class="fc" id="L183">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>