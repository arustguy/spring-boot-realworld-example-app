<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ArticleMutation.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">spring-boot-realworld-example-app</a> &gt; <a href="index.source.html" class="el_package">io.spring.graphql</a> &gt; <span class="el_source">ArticleMutation.java</span></div><h1>ArticleMutation.java</h1><pre class="source lang-java linenums">package io.spring.graphql;

import com.netflix.graphql.dgs.DgsComponent;
import com.netflix.graphql.dgs.DgsMutation;
import com.netflix.graphql.dgs.InputArgument;
import graphql.execution.DataFetcherResult;
import io.spring.api.exception.NoAuthorizationException;
import io.spring.api.exception.ResourceNotFoundException;
import io.spring.application.article.ArticleCommandService;
import io.spring.application.article.NewArticleParam;
import io.spring.application.article.UpdateArticleParam;
import io.spring.core.article.Article;
import io.spring.core.article.ArticleRepository;
import io.spring.core.favorite.ArticleFavorite;
import io.spring.core.favorite.ArticleFavoriteRepository;
import io.spring.core.service.AuthorizationService;
import io.spring.core.user.User;
import io.spring.graphql.DgsConstants.MUTATION;
import io.spring.graphql.exception.AuthenticationException;
import io.spring.graphql.types.ArticlePayload;
import io.spring.graphql.types.CreateArticleInput;
import io.spring.graphql.types.DeletionStatus;
import io.spring.graphql.types.UpdateArticleInput;
import java.util.Collections;
import lombok.AllArgsConstructor;

@DgsComponent
<span class="fc" id="L28">@AllArgsConstructor</span>
public class ArticleMutation {

  private ArticleCommandService articleCommandService;
  private ArticleFavoriteRepository articleFavoriteRepository;
  private ArticleRepository articleRepository;

  @DgsMutation(field = MUTATION.CreateArticle)
  public DataFetcherResult&lt;ArticlePayload&gt; createArticle(
      @InputArgument(&quot;input&quot;) CreateArticleInput input) {
<span class="nc" id="L38">    User user = SecurityUtil.getCurrentUser().orElseThrow(AuthenticationException::new);</span>
    NewArticleParam newArticleParam =
<span class="nc" id="L40">        NewArticleParam.builder()</span>
<span class="nc" id="L41">            .title(input.getTitle())</span>
<span class="nc" id="L42">            .description(input.getDescription())</span>
<span class="nc" id="L43">            .body(input.getBody())</span>
<span class="nc bnc" id="L44" title="All 2 branches missed.">            .tagList(input.getTagList() == null ? Collections.emptyList() : input.getTagList())</span>
<span class="nc" id="L45">            .build();</span>
<span class="nc" id="L46">    Article article = articleCommandService.createArticle(newArticleParam, user);</span>
<span class="nc" id="L47">    return DataFetcherResult.&lt;ArticlePayload&gt;newResult()</span>
<span class="nc" id="L48">        .data(ArticlePayload.newBuilder().build())</span>
<span class="nc" id="L49">        .localContext(article)</span>
<span class="nc" id="L50">        .build();</span>
  }

  @DgsMutation(field = MUTATION.UpdateArticle)
  public DataFetcherResult&lt;ArticlePayload&gt; updateArticle(
      @InputArgument(&quot;slug&quot;) String slug, @InputArgument(&quot;changes&quot;) UpdateArticleInput params) {
<span class="nc" id="L56">    Article article =</span>
<span class="nc" id="L57">        articleRepository.findBySlug(slug).orElseThrow(ResourceNotFoundException::new);</span>
<span class="nc" id="L58">    User user = SecurityUtil.getCurrentUser().orElseThrow(AuthenticationException::new);</span>
<span class="nc bnc" id="L59" title="All 2 branches missed.">    if (!AuthorizationService.canWriteArticle(user, article)) {</span>
<span class="nc" id="L60">      throw new NoAuthorizationException();</span>
    }
<span class="nc" id="L62">    article =</span>
<span class="nc" id="L63">        articleCommandService.updateArticle(</span>
            article,
<span class="nc" id="L65">            new UpdateArticleParam(params.getTitle(), params.getBody(), params.getDescription()));</span>
<span class="nc" id="L66">    return DataFetcherResult.&lt;ArticlePayload&gt;newResult()</span>
<span class="nc" id="L67">        .data(ArticlePayload.newBuilder().build())</span>
<span class="nc" id="L68">        .localContext(article)</span>
<span class="nc" id="L69">        .build();</span>
  }

  @DgsMutation(field = MUTATION.FavoriteArticle)
  public DataFetcherResult&lt;ArticlePayload&gt; favoriteArticle(@InputArgument(&quot;slug&quot;) String slug) {
<span class="nc" id="L74">    User user = SecurityUtil.getCurrentUser().orElseThrow(AuthenticationException::new);</span>
<span class="nc" id="L75">    Article article =</span>
<span class="nc" id="L76">        articleRepository.findBySlug(slug).orElseThrow(ResourceNotFoundException::new);</span>
<span class="nc" id="L77">    ArticleFavorite articleFavorite = new ArticleFavorite(article.getId(), user.getId());</span>
<span class="nc" id="L78">    articleFavoriteRepository.save(articleFavorite);</span>
<span class="nc" id="L79">    return DataFetcherResult.&lt;ArticlePayload&gt;newResult()</span>
<span class="nc" id="L80">        .data(ArticlePayload.newBuilder().build())</span>
<span class="nc" id="L81">        .localContext(article)</span>
<span class="nc" id="L82">        .build();</span>
  }

  @DgsMutation(field = MUTATION.UnfavoriteArticle)
  public DataFetcherResult&lt;ArticlePayload&gt; unfavoriteArticle(@InputArgument(&quot;slug&quot;) String slug) {
<span class="nc" id="L87">    User user = SecurityUtil.getCurrentUser().orElseThrow(AuthenticationException::new);</span>
<span class="nc" id="L88">    Article article =</span>
<span class="nc" id="L89">        articleRepository.findBySlug(slug).orElseThrow(ResourceNotFoundException::new);</span>
<span class="nc" id="L90">    articleFavoriteRepository</span>
<span class="nc" id="L91">        .find(article.getId(), user.getId())</span>
<span class="nc" id="L92">        .ifPresent(</span>
            favorite -&gt; {
<span class="nc" id="L94">              articleFavoriteRepository.remove(favorite);</span>
<span class="nc" id="L95">            });</span>
<span class="nc" id="L96">    return DataFetcherResult.&lt;ArticlePayload&gt;newResult()</span>
<span class="nc" id="L97">        .data(ArticlePayload.newBuilder().build())</span>
<span class="nc" id="L98">        .localContext(article)</span>
<span class="nc" id="L99">        .build();</span>
  }

  @DgsMutation(field = MUTATION.DeleteArticle)
  public DeletionStatus deleteArticle(@InputArgument(&quot;slug&quot;) String slug) {
<span class="nc" id="L104">    User user = SecurityUtil.getCurrentUser().orElseThrow(AuthenticationException::new);</span>
<span class="nc" id="L105">    Article article =</span>
<span class="nc" id="L106">        articleRepository.findBySlug(slug).orElseThrow(ResourceNotFoundException::new);</span>

<span class="nc bnc" id="L108" title="All 2 branches missed.">    if (!AuthorizationService.canWriteArticle(user, article)) {</span>
<span class="nc" id="L109">      throw new NoAuthorizationException();</span>
    }

<span class="nc" id="L112">    articleRepository.remove(article);</span>
<span class="nc" id="L113">    return DeletionStatus.newBuilder().success(true).build();</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>